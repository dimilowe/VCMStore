import {
  pgTable,
  text,
  varchar,
  timestamp,
  jsonb,
  index,
  serial,
  decimal,
  integer,
  boolean,
  uuid,
} from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// Session storage table (required for Replit Auth)
export const sessions = pgTable(
  "sessions",
  {
    sid: varchar("sid").primaryKey(),
    sess: jsonb("sess").notNull(),
    expire: timestamp("expire").notNull(),
  },
  (table) => [index("IDX_session_expire").on(table.expire)],
);

// User storage table (required for Replit Auth)
export const users = pgTable("users", {
  id: varchar("id").primaryKey().notNull(),
  email: varchar("email").unique(),
  firstName: varchar("first_name"),
  lastName: varchar("last_name"),
  profileImageUrl: varchar("profile_image_url"),
  stripeCustomerId: varchar("stripe_customer_id"),
  // Payout preferences for manual payouts
  payoutMethod: varchar("payout_method"), // "paypal", "wise", etc.
  payoutEmail: varchar("payout_email"), // PayPal email or contact info
  payoutEnabled: boolean("payout_enabled").default(false),
  stripeSubscriptionId: varchar("stripe_subscription_id"),
  subscriptionTier: varchar("subscription_tier").default("free"), // "free" or "pro"
  subscriptionStatus: varchar("subscription_status"), // "active", "canceled", etc.
  subscriptionEndsAt: timestamp("subscription_ends_at"),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Content table for uploaded files and paywalled content
export const content = pgTable("content", {
  id: serial("id").primaryKey(),
  userId: varchar("user_id").notNull().references(() => users.id),
  title: varchar("title").notNull(),
  description: text("description"),
  price: decimal("price", { precision: 10, scale: 2 }).notNull(),
  pricingModel: varchar("pricing_model").notNull().default("fixed"), // 'fixed' or 'pay_what_you_want'
  minimumPrice: decimal("minimum_price", { precision: 10, scale: 2 }), // For pay-what-you-want, optional minimum
  category: varchar("category"),
  accessType: varchar("access_type").notNull(), // 'download', 'view', 'stream', 'link'
  fileUrl: text("file_url"),
  fileName: varchar("file_name"),
  fileSize: integer("file_size"),
  mimeType: varchar("mime_type"),
  previewImage: varchar("preview_image"), // Path to preview image
  linkUrl: text("link_url"),
  textContent: text("text_content"),
  isActive: boolean("is_active").default(true),
  unlockCount: integer("unlock_count").default(0),
  totalEarnings: decimal("total_earnings", { precision: 10, scale: 2 }).default("0"),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Purchases/unlocks table
export const purchases = pgTable("purchases", {
  id: serial("id").primaryKey(),
  contentId: integer("content_id").notNull().references(() => content.id),
  buyerEmail: varchar("buyer_email"),
  stripePaymentIntentId: varchar("stripe_payment_intent_id").notNull(),
  amount: decimal("amount", { precision: 10, scale: 2 }).notNull(),
  commission: decimal("commission", { precision: 10, scale: 2 }).notNull().default("0.00"),
  creatorEarning: decimal("creator_earning", { precision: 10, scale: 2 }).notNull().default("0.00"),
  creatorPaid: boolean("creator_paid").notNull().default(false),
  payoutDate: timestamp("payout_date"),
  status: varchar("status").notNull(), // 'pending', 'completed', 'failed'
  // Upsell funnel support
  parentTransactionId: varchar("parent_transaction_id"),
  isUpsell: boolean("is_upsell").default(false),
  funnelId: uuid("funnel_id"),
  abTestId: uuid("ab_test_id"),
  abVariantKey: varchar("ab_variant_key"),
  createdAt: timestamp("created_at").defaultNow(),
});

// Earnings tracking table - logs every payment
export const earnings = pgTable("earnings", {
  id: uuid("id").primaryKey().defaultRandom(),
  creatorId: varchar("creator_id").notNull().references(() => users.id),
  fanId: varchar("fan_id"), // Optional - buyer identifier
  amount: decimal("amount", { precision: 10, scale: 2 }).notNull(), // Total payment from Stripe
  netAmount: decimal("net_amount", { precision: 10, scale: 2 }).notNull(), // After platform fee
  platformFeePct: decimal("platform_fee_pct", { precision: 5, scale: 2 }).notNull(), // % platform keeps
  type: varchar("type").notNull(), // "tip", "subscription", "ppv", "content_purchase"
  status: varchar("status").notNull().default("available"), // "available", "paid", "pending"
  source: varchar("source").notNull().default("APE"), // "APE", "DanceStash", etc.
  stripePaymentIntentId: varchar("stripe_payment_intent_id"),
  contentId: integer("content_id").references(() => content.id), // Optional - if related to content
  createdAt: timestamp("created_at").defaultNow(),
  paidOutAt: timestamp("paid_out_at"),
});

// Balances cache table (optional for quick lookups)
export const balances = pgTable("balances", {
  creatorId: varchar("creator_id").primaryKey().references(() => users.id),
  currentBalance: decimal("current_balance", { precision: 10, scale: 2 }).notNull().default("0"),
  lastPayoutDate: timestamp("last_payout_date"),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Payout logs table
export const payoutLogs = pgTable("payout_logs", {
  id: uuid("id").primaryKey().defaultRandom(),
  creatorId: varchar("creator_id").notNull().references(() => users.id),
  amount: decimal("amount", { precision: 10, scale: 2 }).notNull(),
  payoutMethod: varchar("payout_method").notNull(), // "paypal", "wise"
  payoutEmail: varchar("payout_email").notNull(),
  notes: text("notes"), // e.g. "July 1-20 payout"
  createdAt: timestamp("created_at").defaultNow(),
});

// Funnels table
export const funnels = pgTable("funnels", {
  id: uuid("id").primaryKey().defaultRandom(),
  creatorId: varchar("creator_id").notNull().references(() => users.id),
  name: text("name").notNull(),
  isActive: boolean("is_active").default(true),
  testMode: boolean("test_mode").default(false), // Test mode for previewing funnels
  createdAt: timestamp("created_at").defaultNow(),
});

// Products-to-Funnels mapping
export const productFunnels = pgTable("product_funnels", {
  id: uuid("id").primaryKey().defaultRandom(),
  creatorId: varchar("creator_id").notNull().references(() => users.id),
  contentId: integer("content_id").notNull().references(() => content.id),
  funnelId: uuid("funnel_id").notNull().references(() => funnels.id),
  createdAt: timestamp("created_at").defaultNow(),
});

// Upsell steps in a funnel
export const funnelUpsellSteps = pgTable(
  "funnel_upsell_steps",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    funnelId: uuid("funnel_id").notNull().references(() => funnels.id),
    stepOrder: integer("step_order").notNull(),
    stepType: text("step_type").notNull().default("upsell"), // "upsell" or "downsell"
    title: text("title").notNull(),
    description: text("description"),
    offerPriceId: text("offer_price_id").notNull(), // Stripe price_id
    ctaText: text("cta_text").default("Add this to my order"),
    contentId: integer("content_id").references(() => content.id), // Reference to actual content
    createdAt: timestamp("created_at").defaultNow(),
  },
  (table) => [
    index("idx_funnel_steps_funnel_order").on(table.funnelId, table.stepOrder),
  ]
);

// A/B tests for funnels
export const funnelAbTests = pgTable("funnel_ab_tests", {
  id: uuid("id").primaryKey().defaultRandom(),
  funnelId: uuid("funnel_id").notNull().references(() => funnels.id),
  name: text("name").notNull(),
  status: varchar("status").notNull().default("running"), // running | paused | completed
  createdAt: timestamp("created_at").defaultNow(),
});

// A/B test variants
export const funnelAbVariants = pgTable(
  "funnel_ab_variants",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    abTestId: uuid("ab_test_id").notNull().references(() => funnelAbTests.id),
    key: varchar("key").notNull(), // 'A' or 'B'
    config: jsonb("config").notNull(), // arbitrary config
    trafficPct: integer("traffic_pct").notNull().default(50),
    createdAt: timestamp("created_at").defaultNow(),
  },
  (table) => [
    index("idx_ab_variant_unique").on(table.abTestId, table.key),
  ]
);

// A/B test events and tracking
export const funnelAbEvents = pgTable(
  "funnel_ab_events",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    abTestId: uuid("ab_test_id").notNull().references(() => funnelAbTests.id),
    variantKey: varchar("variant_key").notNull(),
    sessionId: text("session_id").notNull(),
    eventType: varchar("event_type").notNull(), // 'exposure' | 'purchase' | 'upsell_accept'
    amountCents: integer("amount_cents"),
    meta: jsonb("meta"),
    createdAt: timestamp("created_at").defaultNow(),
  },
  (table) => [
    index("idx_events_abtest_variant").on(table.abTestId, table.variantKey, table.eventType),
  ]
);

// Schema exports
export const insertUserSchema = createInsertSchema(users);
export const insertContentSchema = createInsertSchema(content).omit({
  id: true,
  unlockCount: true,
  totalEarnings: true,
  createdAt: true,
  updatedAt: true,
});
export const insertPurchaseSchema = createInsertSchema(purchases).omit({
  id: true,
  createdAt: true,
});

// Type exports
export type UpsertUser = z.infer<typeof insertUserSchema>;
export type User = typeof users.$inferSelect;
export type Content = typeof content.$inferSelect;
export type InsertContent = z.infer<typeof insertContentSchema>;
export type Purchase = typeof purchases.$inferSelect;
export type InsertPurchase = z.infer<typeof insertPurchaseSchema>;

// Funnel types
export type Funnel = typeof funnels.$inferSelect;
export type InsertFunnel = typeof funnels.$inferInsert;
export type ProductFunnel = typeof productFunnels.$inferSelect;
export type InsertProductFunnel = typeof productFunnels.$inferInsert;
export type FunnelUpsellStep = typeof funnelUpsellSteps.$inferSelect;
export type InsertFunnelUpsellStep = typeof funnelUpsellSteps.$inferInsert;
export type FunnelAbTest = typeof funnelAbTests.$inferSelect;
export type InsertFunnelAbTest = typeof funnelAbTests.$inferInsert;
export type FunnelAbVariant = typeof funnelAbVariants.$inferSelect;
export type InsertFunnelAbVariant = typeof funnelAbVariants.$inferInsert;
export type FunnelAbEvent = typeof funnelAbEvents.$inferSelect;
export type InsertFunnelAbEvent = typeof funnelAbEvents.$inferInsert;

// Earnings types
export type Earning = typeof earnings.$inferSelect;
export type InsertEarning = typeof earnings.$inferInsert;
export const insertEarningSchema = createInsertSchema(earnings);

// Balance types
export type Balance = typeof balances.$inferSelect;
export type InsertBalance = typeof balances.$inferInsert;
export const insertBalanceSchema = createInsertSchema(balances);

// Payout log types
export type PayoutLog = typeof payoutLogs.$inferSelect;
export type InsertPayoutLog = typeof payoutLogs.$inferInsert;
export const insertPayoutLogSchema = createInsertSchema(payoutLogs);

// NEW FUNNEL SYSTEM TABLES

// Lead table for email capture and UTM tracking
export const leads = pgTable("leads", {
  id: serial("id").primaryKey(),
  email: varchar("email").unique().notNull(),
  consent: boolean("consent").notNull().default(true),
  source: varchar("source"), // freebie slug or source identifier
  utmSource: varchar("utm_source"),
  utmMedium: varchar("utm_medium"), 
  utmCampaign: varchar("utm_campaign"),
  createdAt: timestamp("created_at").defaultNow(),
});

// Asset table for downloadable files (freebies + tripwires)
export const assets = pgTable("assets", {
  id: serial("id").primaryKey(),
  title: varchar("title").notNull(),
  description: text("description"),
  filePath: text("file_path"), // local file path
  storageUrl: text("storage_url"), // cloud storage URL
  checksum: varchar("checksum"), // for file integrity
  isFree: boolean("is_free").notNull().default(false),
  createdAt: timestamp("created_at").defaultNow(),
});

// Offer table for tripwires and upsells
export const offers = pgTable("offers", {
  id: serial("id").primaryKey(),
  slug: varchar("slug").unique().notNull(),
  title: varchar("title").notNull(),
  description: text("description"),
  priceCents: integer("price_cents").notNull(),
  currency: varchar("currency").notNull().default("usd"),
  assetId: integer("asset_id").references(() => assets.id),
  isTripwire: boolean("is_tripwire").notNull().default(false),
  isActive: boolean("is_active").notNull().default(true),
  createdBy: varchar("created_by").notNull(), // user ID of the creator
  createdAt: timestamp("created_at").defaultNow(),
});

// Freebie table for lead magnets
export const freebies = pgTable("freebies", {
  id: serial("id").primaryKey(),
  slug: varchar("slug").unique().notNull(),
  headline: text("headline").notNull(),
  subcopy: text("subcopy"),
  heroImage: text("hero_image"), // path to hero image
  benefits: text("benefits").array(), // array of benefit bullet points
  assetId: integer("asset_id").notNull().references(() => assets.id),
  thankYouUpsellId: integer("thank_you_upsell_id").references(() => offers.id), // deprecated, use thankYouContentId
  thankYouContentId: integer("thank_you_content_id").references(() => content.id), // link to paid content as tripwire
  createdBy: varchar("created_by").notNull(), // user ID of the creator
  createdAt: timestamp("created_at").defaultNow(),
});

// Freebie upsells table for multiple sequential tripwire offers
export const freebieUpsells = pgTable("freebie_upsells", {
  id: serial("id").primaryKey(),
  freebieId: integer("freebie_id").notNull().references(() => freebies.id, { onDelete: "cascade" }),
  contentId: integer("content_id").notNull().references(() => content.id),
  stepOrder: integer("step_order").notNull(),
  createdAt: timestamp("created_at").defaultNow(),
});

// Order table for purchase tracking  
export const orders = pgTable("orders", {
  id: serial("id").primaryKey(),
  leadId: integer("lead_id").notNull().references(() => leads.id),
  offerId: integer("offer_id").notNull().references(() => offers.id),
  stripeCustomerId: varchar("stripe_customer_id"),
  stripePaymentIntentId: varchar("stripe_payment_intent_id"),
  amountCents: integer("amount_cents").notNull(),
  status: varchar("status").notNull().default("paid"), // paid, refunded, failed
  createdAt: timestamp("created_at").defaultNow(),
});

// Upsell mapping table
export const upsells = pgTable("upsells", {
  id: serial("id").primaryKey(),
  primaryOfferId: integer("primary_offer_id").notNull().references(() => offers.id),
  upsellOfferId: integer("upsell_offer_id").notNull().references(() => offers.id),
  headline: text("headline").notNull(),
  subcopy: text("subcopy"),
  createdAt: timestamp("created_at").defaultNow(),
});

// Download token table for secure file access
export const downloadTokens = pgTable("download_tokens", {
  id: serial("id").primaryKey(),
  leadId: integer("lead_id").notNull().references(() => leads.id),
  assetId: integer("asset_id").notNull().references(() => assets.id),
  jwtToken: text("jwt_token").notNull(),
  expiresAt: timestamp("expires_at").notNull(),
  redeemed: boolean("redeemed").notNull().default(false),
  createdAt: timestamp("created_at").defaultNow(),
});

// Event table for analytics and tracking
export const events = pgTable("events", {
  id: serial("id").primaryKey(),
  leadId: integer("lead_id").references(() => leads.id),
  type: varchar("type").notNull(), // freebie_opt_in, tripwire_view, etc.
  payload: jsonb("payload"), // additional event data
  createdAt: timestamp("created_at").defaultNow(),
});

// Insert schemas for new tables
export const insertLeadSchema = createInsertSchema(leads).omit({ 
  id: true, 
  createdAt: true 
});
export const insertAssetSchema = createInsertSchema(assets).omit({
  id: true,
  createdAt: true,
});
export const insertFreebieSchema = createInsertSchema(freebies).omit({
  id: true,
  createdAt: true,
});
export const insertFreebieUpsellSchema = createInsertSchema(freebieUpsells).omit({
  id: true,
  createdAt: true,
});
export const insertOfferSchema = createInsertSchema(offers).omit({
  id: true,
  createdAt: true,
});
export const insertOrderSchema = createInsertSchema(orders).omit({
  id: true,
  createdAt: true,
});
export const insertUpsellSchema = createInsertSchema(upsells).omit({
  id: true,
  createdAt: true,
});
export const insertDownloadTokenSchema = createInsertSchema(downloadTokens).omit({
  id: true,
  createdAt: true,
});
export const insertEventSchema = createInsertSchema(events).omit({
  id: true,
  createdAt: true,
});

// Type exports for new tables
export type Lead = typeof leads.$inferSelect;
export type InsertLead = z.infer<typeof insertLeadSchema>;
export type Asset = typeof assets.$inferSelect;
export type InsertAsset = z.infer<typeof insertAssetSchema>;
export type Freebie = typeof freebies.$inferSelect;
export type InsertFreebie = z.infer<typeof insertFreebieSchema>;
export type FreebieUpsell = typeof freebieUpsells.$inferSelect;
export type InsertFreebieUpsell = z.infer<typeof insertFreebieUpsellSchema>;
export type Offer = typeof offers.$inferSelect;
export type InsertOffer = z.infer<typeof insertOfferSchema>;
export type Order = typeof orders.$inferSelect;
export type InsertOrder = z.infer<typeof insertOrderSchema>;
export type Upsell = typeof upsells.$inferSelect;
export type InsertUpsell = z.infer<typeof insertUpsellSchema>;
export type DownloadToken = typeof downloadTokens.$inferSelect;
export type InsertDownloadToken = z.infer<typeof insertDownloadTokenSchema>;
export type Event = typeof events.$inferSelect;
export type InsertEvent = z.infer<typeof insertEventSchema>;
